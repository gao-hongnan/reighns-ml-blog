
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://gao-hongnan.github.io/reighns-ml-blog/reighns_ml_journey/machine_learning_and_deep_learning/computer_vision/object_detection/faster_rcnn/">
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.13">
    
    
      
        <title>Faster rcnn - Hongnan G. Machine Learning Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.e411adfe.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../css/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#imports" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Hongnan G. Machine Learning Blog" class="md-header__button md-logo" aria-label="Hongnan G. Machine Learning Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Hongnan G. Machine Learning Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Faster rcnn
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/gao-hongnan" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM277.3 415.7c-8.4 1.5-11.5-3.7-11.5-8 0-5.4.2-33 .2-55.3 0-15.6-5.2-25.5-11.3-30.7 37-4.1 76-9.2 76-73.1 0-18.2-6.5-27.3-17.1-39 1.7-4.3 7.4-22-1.7-45-13.9-4.3-45.7 17.9-45.7 17.9-13.2-3.7-27.5-5.6-41.6-5.6-14.1 0-28.4 1.9-41.6 5.6 0 0-31.8-22.2-45.7-17.9-9.1 22.9-3.5 40.6-1.7 45-10.6 11.7-15.6 20.8-15.6 39 0 63.6 37.3 69 74.3 73.1-4.8 4.3-9.1 11.7-10.6 22.3-9.5 4.3-33.8 11.7-48.3-13.9-9.1-15.8-25.5-17.1-25.5-17.1-16.2-.2-1.1 10.2-1.1 10.2 10.8 5 18.4 24.2 18.4 24.2 9.7 29.7 56.1 19.7 56.1 19.7 0 13.9.2 36.5.2 40.6 0 4.3-3 9.5-11.5 8-66-22.1-112.2-84.9-112.2-158.3 0-91.8 70.2-161.5 162-161.5S388 165.6 388 257.4c.1 73.4-44.7 136.3-110.7 158.3zm-98.1-61.1c-1.9.4-3.7-.4-3.9-1.7-.2-1.5 1.1-2.8 3-3.2 1.9-.2 3.7.6 3.9 1.9.3 1.3-1 2.6-3 3zm-9.5-.9c0 1.3-1.5 2.4-3.5 2.4-2.2.2-3.7-.9-3.7-2.4 0-1.3 1.5-2.4 3.5-2.4 1.9-.2 3.7.9 3.7 2.4zm-13.7-1.1c-.4 1.3-2.4 1.9-4.1 1.3-1.9-.4-3.2-1.9-2.8-3.2.4-1.3 2.4-1.9 4.1-1.5 2 .6 3.3 2.1 2.8 3.4zm-12.3-5.4c-.9 1.1-2.8.9-4.3-.6-1.5-1.3-1.9-3.2-.9-4.1.9-1.1 2.8-.9 4.3.6 1.3 1.3 1.8 3.3.9 4.1zm-9.1-9.1c-.9.6-2.6 0-3.7-1.5s-1.1-3.2 0-3.9c1.1-.9 2.8-.2 3.7 1.3 1.1 1.5 1.1 3.3 0 4.1zm-6.5-9.7c-.9.9-2.4.4-3.5-.6-1.1-1.3-1.3-2.8-.4-3.5.9-.9 2.4-.4 3.5.6 1.1 1.3 1.3 2.8.4 3.5zm-6.7-7.4c-.4.9-1.7 1.1-2.8.4-1.3-.6-1.9-1.7-1.5-2.6.4-.6 1.5-.9 2.8-.4 1.3.7 1.9 1.8 1.5 2.6z"/></svg>
  </div>
  <div class="md-source__repository">
    gao-hongnan
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Hongnan G. Machine Learning Blog" class="md-nav__button md-logo" aria-label="Hongnan G. Machine Learning Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Hongnan G. Machine Learning Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/gao-hongnan" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M400 32H48C21.5 32 0 53.5 0 80v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V80c0-26.5-21.5-48-48-48zM277.3 415.7c-8.4 1.5-11.5-3.7-11.5-8 0-5.4.2-33 .2-55.3 0-15.6-5.2-25.5-11.3-30.7 37-4.1 76-9.2 76-73.1 0-18.2-6.5-27.3-17.1-39 1.7-4.3 7.4-22-1.7-45-13.9-4.3-45.7 17.9-45.7 17.9-13.2-3.7-27.5-5.6-41.6-5.6-14.1 0-28.4 1.9-41.6 5.6 0 0-31.8-22.2-45.7-17.9-9.1 22.9-3.5 40.6-1.7 45-10.6 11.7-15.6 20.8-15.6 39 0 63.6 37.3 69 74.3 73.1-4.8 4.3-9.1 11.7-10.6 22.3-9.5 4.3-33.8 11.7-48.3-13.9-9.1-15.8-25.5-17.1-25.5-17.1-16.2-.2-1.1 10.2-1.1 10.2 10.8 5 18.4 24.2 18.4 24.2 9.7 29.7 56.1 19.7 56.1 19.7 0 13.9.2 36.5.2 40.6 0 4.3-3 9.5-11.5 8-66-22.1-112.2-84.9-112.2-158.3 0-91.8 70.2-161.5 162-161.5S388 165.6 388 257.4c.1 73.4-44.7 136.3-110.7 158.3zm-98.1-61.1c-1.9.4-3.7-.4-3.9-1.7-.2-1.5 1.1-2.8 3-3.2 1.9-.2 3.7.6 3.9 1.9.3 1.3-1 2.6-3 3zm-9.5-.9c0 1.3-1.5 2.4-3.5 2.4-2.2.2-3.7-.9-3.7-2.4 0-1.3 1.5-2.4 3.5-2.4 1.9-.2 3.7.9 3.7 2.4zm-13.7-1.1c-.4 1.3-2.4 1.9-4.1 1.3-1.9-.4-3.2-1.9-2.8-3.2.4-1.3 2.4-1.9 4.1-1.5 2 .6 3.3 2.1 2.8 3.4zm-12.3-5.4c-.9 1.1-2.8.9-4.3-.6-1.5-1.3-1.9-3.2-.9-4.1.9-1.1 2.8-.9 4.3.6 1.3 1.3 1.8 3.3.9 4.1zm-9.1-9.1c-.9.6-2.6 0-3.7-1.5s-1.1-3.2 0-3.9c1.1-.9 2.8-.2 3.7 1.3 1.1 1.5 1.1 3.3 0 4.1zm-6.5-9.7c-.9.9-2.4.4-3.5-.6-1.1-1.3-1.3-2.8-.4-3.5.9-.9 2.4-.4 3.5.6 1.1 1.3 1.3 2.8.4 3.5zm-6.7-7.4c-.4.9-1.7 1.1-2.8.4-1.3-.6-1.9-1.7-1.5-2.6.4-.6 1.5-.9 2.8-.4 1.3.7 1.9 1.8 1.5 2.6z"/></svg>
  </div>
  <div class="md-source__repository">
    gao-hongnan
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../../about/" class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../../sp_ppe/" class="md-nav__link">
        SP PPE
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Mathematics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Mathematics" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Mathematics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/general_mathematical_terms_and_definitions.md" class="md-nav__link">
        General Mathematic Terms and Definitions
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2" type="checkbox" id="__nav_4_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2">
          Linear Algebra
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linear Algebra" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          Linear Algebra
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_1" type="checkbox" id="__nav_4_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_1">
          Vectors
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Vectors" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_2_1">
          <span class="md-nav__icon md-icon"></span>
          Vectors
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_1_1" type="checkbox" id="__nav_4_2_1_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_1_1">
          Vector Products
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Vector Products" data-md-level="4">
        <label class="md-nav__title" for="__nav_4_2_1_1">
          <span class="md-nav__icon md-icon"></span>
          Vector Products
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/02_vectors/02_linear_algebra_vectors_outer_product.md" class="md-nav__link">
        Outer Product
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/02_vectors/02_linear_algebra_vectors_unit_vector/" class="md-nav__link">
        Unit Vector
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/02_vectors/02_linear_algebra_vectors_exercises/" class="md-nav__link">
        Exercises
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_2" type="checkbox" id="__nav_4_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_2">
          Vector Spaces
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Vector Spaces" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_2_2">
          <span class="md-nav__icon md-icon"></span>
          Vector Spaces
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/03_vector_spaces/03_linear_algebra_vector_spaces_vector_subspaces/" class="md-nav__link">
        Vector Space and Subspaces
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/03_vector_spaces/03_linear_algebra_vector_spaces_vector_span/" class="md-nav__link">
        Vector Span
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/03_vector_spaces/03_linear_algebra_vector_spaces_linear_independence/" class="md-nav__link">
        Linear Independence
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/03_vector_spaces/03_linear_algebra_vector_spaces_basis_dimension/" class="md-nav__link">
        Basis and Dimension
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_3" type="checkbox" id="__nav_4_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_3">
          Matrix
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Matrix" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_2_3">
          <span class="md-nav__icon md-icon"></span>
          Matrix
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/04_matrices/04_linear_algebra_matrix/" class="md-nav__link">
        Matrix
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/04_matrices/04_linear_algebra_matrix_basic_matrix_types/" class="md-nav__link">
        Basic Matrix Types
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/04_matrices/04_linear_algebra_matrix_basic_operations/" class="md-nav__link">
        Basic Matrix Operations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/04_matrices/04_linear_algebra_matrix_multiplication/" class="md-nav__link">
        Matrix Multiplication
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_4" type="checkbox" id="__nav_4_2_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_4">
          Matrix Theory
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Matrix Theory" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_2_4">
          <span class="md-nav__icon md-icon"></span>
          Matrix Theory
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/05_system_of_linear_equations_and_matrix_theory/05.01_linear_algebra_systems_of_linear_equations.md" class="md-nav__link">
        System of Linear Equations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/05_system_of_linear_equations_and_matrix_theory/05.02_linear_algebra_row_reduction_preserves_rank/" class="md-nav__link">
        Row Reduction Preserves Rank
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/05_system_of_linear_equations_and_matrix_theory/05.03_linear_algebra_matrix_theory_matrix_spaces_row_space/" class="md-nav__link">
        Row Space
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/05_system_of_linear_equations_and_matrix_theory/05.04_linear_algebra_matrix_theory_matrix_spaces_column_space/" class="md-nav__link">
        Column Space
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/05_system_of_linear_equations_and_matrix_theory/05.05_linear_algebra_matrix_theory_matrix_spaces_right_nullspace/" class="md-nav__link">
        Right Nullspace (Kernel)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/05_system_of_linear_equations_and_matrix_theory/05.06_linear_algebra_matrix_theory_matrix_spaces_left_nullspace/" class="md-nav__link">
        Left Nullspace
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/05_system_of_linear_equations_and_matrix_theory/05.07_linear_algebra_matrix_theory_matrix_rank/" class="md-nav__link">
        Matrix Rank
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/05_system_of_linear_equations_and_matrix_theory/05.08_linear_algebra_matrix_theory_matrix_spaces_summary/" class="md-nav__link">
        The Four Fundamental Subspaces (Summary)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_5" type="checkbox" id="__nav_4_2_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_5">
          Linear Transformation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linear Transformation" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_2_5">
          <span class="md-nav__icon md-icon"></span>
          Linear Transformation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/06_linear_transformation/06.01_linear_algebra_linear_transformations/" class="md-nav__link">
        Linear Transformation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/06_linear_transformation/06.02_linear_algebra_linear_transformations_nullspace/" class="md-nav__link">
        Nullspace
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/06_linear_transformation/06.03_linear_algebra_linear_transformations_ranges/" class="md-nav__link">
        Range
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/06_linear_transformation/06.04_linear_algebra_linear_transformations_homomorphism/" class="md-nav__link">
        Homomorphism
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/06_linear_transformation/06.05_linear_algebra_linear_transformations_fundamental_theorem/" class="md-nav__link">
        Fundamental Theorem
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/06_linear_transformation/06.06_linear_algebra_linear_transformations_matrix/" class="md-nav__link">
        Linear Transformation and Matrix
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_2_6" type="checkbox" id="__nav_4_2_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_2_6">
          Analytic Geometry
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Analytic Geometry" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_2_6">
          <span class="md-nav__icon md-icon"></span>
          Analytic Geometry
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/08_analytic_geometry/08.01_motivation/" class="md-nav__link">
        Motivation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/08_analytic_geometry/08.02_norms/" class="md-nav__link">
        Norms
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/08_analytic_geometry/08.03_inner_products/" class="md-nav__link">
        Inner Product Spaces
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/08_analytic_geometry/08.04_lengths_and_distances/" class="md-nav__link">
        Lengths and Distances
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/08_analytic_geometry/08.05_angles_and_orthogonality/" class="md-nav__link">
        Angles and Orthogoanlity
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/08_analytic_geometry/08.06_orthogonal_subspaces/" class="md-nav__link">
        Orthogonal Subspace
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/08_analytic_geometry/08.07_orthogonal_projections/" class="md-nav__link">
        Orthogonal Projection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/08_analytic_geometry/08.08_orthogonal_matrices_and_basis/" class="md-nav__link">
        Orthogonal Matrices and Basis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/08_analytic_geometry/08.09_gram_schmidt_orthogonalization/" class="md-nav__link">
        Gram-Schmidt Orthogonalization
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/linear_algebra/linear_algebra_interview_questions/" class="md-nav__link">
        Interview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3" type="checkbox" id="__nav_4_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3">
          Probability and Statistics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Probability and Statistics" data-md-level="2">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          Probability and Statistics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/probability_statistics_theory/probability4datascience.md" class="md-nav__link">
        Introduction to Probability for Data Science (Stanley H. Chan)
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4_3_2" type="checkbox" id="__nav_4_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4_3_2">
          Introduction to Probability
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Introduction to Probability" data-md-level="3">
        <label class="md-nav__title" for="__nav_4_3_2">
          <span class="md-nav__icon md-icon"></span>
          Introduction to Probability
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/probability_statistics_theory/02_introduction_to_probability/02.01_probability_space.md" class="md-nav__link">
        Probability Space
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/probability_statistics_theory/02_introduction_to_probability/02.02_probability_axioms.md" class="md-nav__link">
        Probability Axioms
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/probability_statistics_theory/02_introduction_to_probability/02.03_conditional_probability.md" class="md-nav__link">
        Conditional Probability
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/probability_statistics_theory/02_introduction_to_probability/02.04_independence.md" class="md-nav__link">
        Independence
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/probability_statistics_theory/02_introduction_to_probability/02.05_bayes_theorem.md" class="md-nav__link">
        Bayes Theorem
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../mathematics/probability_statistics_theory/02_introduction_to_probability/02.06_summary.md" class="md-nav__link">
        Summary
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Machine Learning and Deep Learning
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Machine Learning and Deep Learning" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Machine Learning and Deep Learning
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1" type="checkbox" id="__nav_5_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_1">
          Computer Vision
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Computer Vision" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          Computer Vision
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        README
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_2" type="checkbox" id="__nav_5_1_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_1_2">
          Neural Network Interpretation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Neural Network Interpretation" data-md-level="3">
        <label class="md-nav__title" for="__nav_5_1_2">
          <span class="md-nav__icon md-icon"></span>
          Neural Network Interpretation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_2_1" type="checkbox" id="__nav_5_1_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_1_2_1">
          Visualization of Feature Map Activations
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Visualization of Feature Map Activations" data-md-level="4">
        <label class="md-nav__title" for="__nav_5_1_2_1">
          <span class="md-nav__icon md-icon"></span>
          Visualization of Feature Map Activations
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../neural_network_interpretation/01_feature_map_activation/feature_map_activation/" class="md-nav__link">
        Feature Map Activations (Part I)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../neural_network_interpretation/01_feature_map_activation/feature_map_activation_reduced/" class="md-nav__link">
        Feature Map Activations (Part II)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../neural_network_interpretation/conv_filters/Visualizing Convolutional Filters.md" class="md-nav__link">
        Visualization of Convolutional Filters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../neural_network_interpretation/salient_map/Salient Map.md" class="md-nav__link">
        Salient Map
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1_2_4" type="checkbox" id="__nav_5_1_2_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_1_2_4">
          Grad-CAM
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Grad-CAM" data-md-level="4">
        <label class="md-nav__title" for="__nav_5_1_2_4">
          <span class="md-nav__icon md-icon"></span>
          Grad-CAM
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../neural_network_interpretation/05_gradcam_and_variants/gradcam_explained/" class="md-nav__link">
        Grad-CAM Explained
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../neural_network_interpretation/05_gradcam_and_variants/gradcam_from_scratch/" class="md-nav__link">
        Grad-CAM from Scratch
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../image_normalization/Image_Normalization_and_Standardization/" class="md-nav__link">
        Image Normalization
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_2" type="checkbox" id="__nav_5_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_2">
          Fundamental Concepts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Fundamental Concepts" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          Fundamental Concepts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../fundamentals/loss_functions/cross_entropy_loss/cross_entropy_loss_from_scratch.md" class="md-nav__link">
        Cross Entropy Loss
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_3" type="checkbox" id="__nav_5_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_3">
          Ensemble Theory
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Ensemble Theory" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_3">
          <span class="md-nav__icon md-icon"></span>
          Ensemble Theory
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ensemble_theory/forward_ensemble/" class="md-nav__link">
        Forward Ensemble (Hill Climbing)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Machine Learning Projects
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Machine Learning Projects" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Machine Learning Projects
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/RANZCR%20CLiP%20-%20Catheter%20and%20Line%20Position%20Challenge/notebooks/walkthrough/" class="md-nav__link">
        RANZCR CLiP - Catheter and Line Position Challenge
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/SIIM-ISIC%20Melanoma%20Classification/notebooks/walkthrough/" class="md-nav__link">
        SIIM-ISIC Melanoma Classification
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/LTA_road_cracks_detection/notebooks/walkthrough/" class="md-nav__link">
        LTA
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" type="checkbox" id="__nav_6_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_4">
          Breast Cancer Wisconsin (Supervised Classification)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Breast Cancer Wisconsin (Supervised Classification)" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          Breast Cancer Wisconsin (Supervised Classification)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/breast_cancer_wisconsin/Stage%200%20-%20Introduction%20and%20Problem%20Statement/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/breast_cancer_wisconsin/Stage%201%20-%20Preliminary%20Data%20Inspection%20and%20Cleaning/" class="md-nav__link">
        Preliminary Data Inspection and Cleaning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/breast_cancer_wisconsin/Stage%202%20-%20Preliminary%20EDA/" class="md-nav__link">
        EDA
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/breast_cancer_wisconsin/Stage%203%20-%20Feature%20Engineering/" class="md-nav__link">
        Feature Engineering
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/breast_cancer_wisconsin/Stage%204%20-%20Modelling%20%28Metric%20to%20Optimize%29/" class="md-nav__link">
        Modelling (Metrics)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/breast_cancer_wisconsin/Stage%205%20-%20Modelling%20%28Cross-Validation%20Methodology%29/" class="md-nav__link">
        Modelling (Cross-Validation Schema)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/breast_cancer_wisconsin/Stage%206%20-%20Modelling%20%28Preprocessing%20and%20Spot%20Checking%29/" class="md-nav__link">
        Modelling (Preprocessing and Spot Checking)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/breast_cancer_wisconsin/Stage%207%20-%20Modelling%20%28Model%20Selection%20and%20Hyperparameter%20Tuning%29/" class="md-nav__link">
        Modelling (Model Selection)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../projects/breast_cancer_wisconsin/Stage%208%20-%20Modelling%20%28Model%20Evaluation%20and%20Interpretation%29/" class="md-nav__link">
        Modelling (Model Evaluation)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#imports" class="md-nav__link">
    Imports
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feature-extraction-step" class="md-nav__link">
    Feature Extraction Step
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generate-anchor-boxes-on-each-input-image" class="md-nav__link">
    Generate Anchor Boxes on Each Input Image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iou-of-anchor-box-and-true-bounding-boxes" class="md-nav__link">
    IOU of Anchor Box and True Bounding Boxes!
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-the-iou-value-to-assign-labels-to-each-valid-anchor-box-important" class="md-nav__link">
    Use the IOU value to assign LABELS TO EACH VALID ANCHOR BOX (IMPORTANT)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mini-batch-256" class="md-nav__link">
    Mini-Batch 256
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transform-valid-anchor-boxes-format-from-y1-x1-y2-x2-to-the-correct-format" class="md-nav__link">
    Transform Valid Anchor Boxes Format from (y1, x1, y2, x2) to the correct format
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#region-proposal-network" class="md-nav__link">
    Region Proposal Network
  </a>
  
    <nav class="md-nav" aria-label="Region Proposal Network">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#send-feature-maps-to-rpn-to-produce-22500-regions-of-interests-rois" class="md-nav__link">
    Send Feature Maps to RPN to produce 22500 Regions of Interests (ROIs)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpn-loss" class="md-nav__link">
    RPN LOSS
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nms" class="md-nav__link">
    NMS
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sample-128-from-nmss-2000-rois" class="md-nav__link">
    Sample 128 From NMS's 2000 ROIs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#128-roi-samples-features-and-pool-them" class="md-nav__link">
    128 ROI Samples' Features and Pool them
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pytorch-pre-trained-model" class="md-nav__link">
    PyTorch Pre-trained model
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/gao-hongnan/edit/master/docs/reighns_ml_journey/machine_learning_and_deep_learning/computer_vision/object_detection/faster_rcnn.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>Faster rcnn</h1>

<ul>
<li>https://everitt257.github.io/post/2018/08/10/object_detection.html</li>
<li>https://towardsdatascience.com/deep-learning-for-object-detection-a-comprehensive-review-73930816d8d9</li>
<li><a href="https://www.youtube.com/watch?v=4yOcsWg-7g8">Follow This for basic implementation</a></li>
<li><a href="https://github.com/chingisooinar/Object-Detection_from-Scratch/blob/main/RCNN/RCNN.ipynb">Simple RCNN Implementation</a></li>
</ul>
<h2 id="imports">Imports</h2>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>  <span class="c1"># linear algebra</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  <span class="c1"># data processing, CSV file I/O (e.g. pd.read_csv)</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">PIL</span>
<span class="kn">from</span> <span class="nn">IPython.core.interactiveshell</span> <span class="kn">import</span> <span class="n">InteractiveShell</span>
<span class="kn">from</span> <span class="nn">torchinfo</span> <span class="kn">import</span> <span class="n">summary</span>
<span class="n">InteractiveShell</span><span class="o">.</span><span class="n">ast_node_interactivity</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># importing modules</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="kn">import</span> <span class="nn">bounding_boxes</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()):</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_name</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">device</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>cpu
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">cat_dog_p</span> <span class="o">=</span> <span class="s2">&quot;https://storage.googleapis.com/reighns/reighns_ml_projects/docs/deep_learning/computer_vision/data/misc/catdog.jpg&quot;</span>

<span class="c1"># plot cat and dog with title using PIL</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">cat_dog</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">urlopen</span><span class="p">(</span><span class="n">cat_dog_p</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cat_dog</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Cat and Dog&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span>
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_4_0.png" /></p>
<ul>
<li>Load the image and bbox in the correct format in np array and plot them;</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Object information: a set of bounding boxes [ymin, xmin, ymax, xmax] and their labels </span>
<span class="c1"># dog_bbox, cat_bbox = [60.0, 45.0, 378.0, 516.0], [400.0, 112.0, 655.0, 493.0]</span>
<span class="c1"># unsure why is not xmin ymin format tho.</span>

<span class="n">dog_bbox</span><span class="p">,</span> <span class="n">cat_bbox</span> <span class="o">=</span> <span class="p">[</span><span class="mf">45.0</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">,</span> <span class="mf">516.0</span><span class="p">,</span> <span class="mf">378.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">112.0</span><span class="p">,</span> <span class="mf">400.0</span><span class="p">,</span> <span class="mf">493.0</span><span class="p">,</span> <span class="mf">655.0</span><span class="p">]</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">urlopen</span><span class="p">(</span><span class="n">cat_dog_p</span><span class="p">)))</span>
<span class="n">bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">((</span><span class="n">dog_bbox</span><span class="p">,</span> <span class="n">cat_bbox</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="c1"># 0: background, 1: dog, 2: cat</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bboxes</span><span class="p">)):</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
        <span class="n">img</span><span class="p">,</span>
        <span class="p">(</span><span class="n">bboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">bboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">(</span><span class="n">bboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">bboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span>
        <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">thickness</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span>
        <span class="n">img</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span>
        <span class="p">(</span><span class="n">bboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">bboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="n">thickness</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span>
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_7_0.png" /></p>
<ul>
<li>Our input to the Faster-RCNN should always be 800x800x3, so need to resize!</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">urlopen</span><span class="p">(</span><span class="n">cat_dog_p</span><span class="p">)))</span>
<span class="n">img_resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dsize</span><span class="o">=</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_CUBIC</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_resized</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;matplotlib.image.AxesImage at 0x1dee17471c0&gt;
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_9_1.png" /></p>
<ul>
<li>After resizing the image, the bbox must also be resized to reflect the new coordinates, we do it below;</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># change the bounding box coordinates </span>
<span class="n">Wratio</span> <span class="o">=</span> <span class="mi">800</span><span class="o">/</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">Hratio</span> <span class="o">=</span> <span class="mi">800</span><span class="o">/</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">ratioLst</span> <span class="o">=</span> <span class="p">[</span><span class="n">Hratio</span><span class="p">,</span> <span class="n">Wratio</span><span class="p">,</span> <span class="n">Hratio</span><span class="p">,</span> <span class="n">Wratio</span><span class="p">]</span>
<span class="n">bboxes_resized</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">bboxes</span><span class="p">:</span>
    <span class="n">box</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">ratioLst</span><span class="p">)]</span> 
    <span class="n">bboxes_resized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
<span class="n">bboxes_resized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bboxes_resized</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bboxes_resized</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[[ 64  65 735 415]
 [159 439 703 719]]
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bboxes</span><span class="p">)):</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
        <span class="n">img_resized</span><span class="p">,</span>
        <span class="p">(</span><span class="n">bboxes_resized</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">bboxes_resized</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">(</span><span class="n">bboxes_resized</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">bboxes_resized</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span>
        <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">thickness</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span>
        <span class="n">img_resized</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span>
        <span class="p">(</span><span class="n">bboxes_resized</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">bboxes_resized</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">,</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span>
        <span class="n">thickness</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_resized</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span>
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_12_0.png" /></p>
<h2 id="feature-extraction-step">Feature Extraction Step</h2>
<ul>
<li>Use VGG16 to extract feature maps of the input image.</li>
<li>This means we transform (1, 3, 800, 800) to (1, 512, 50, 50)</li>
</ul>
<p><img alt="img1.png" src="attachment:3341c6f5-e9b3-4929-af71-8a0a8aafd90d.png" /></p>
<div class="highlight"><pre><span></span><code><span class="c1"># List all the layers of VGG16</span>
<span class="n">vgg16</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">vgg16</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">vgg16</span>
<span class="c1"># vgg16.features</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>VGG(
  (features): Sequential(
    (0): Conv2d(3, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (1): ReLU(inplace=True)
    (2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (3): ReLU(inplace=True)
    (4): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (5): Conv2d(64, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (6): ReLU(inplace=True)
    (7): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (8): ReLU(inplace=True)
    (9): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (10): Conv2d(128, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (11): ReLU(inplace=True)
    (12): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (13): ReLU(inplace=True)
    (14): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (15): ReLU(inplace=True)
    (16): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (17): Conv2d(256, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (18): ReLU(inplace=True)
    (19): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (20): ReLU(inplace=True)
    (21): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (22): ReLU(inplace=True)
    (23): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
    (24): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (25): ReLU(inplace=True)
    (26): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (27): ReLU(inplace=True)
    (28): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
    (29): ReLU(inplace=True)
    (30): MaxPool2d(kernel_size=2, stride=2, padding=0, dilation=1, ceil_mode=False)
  )
  (avgpool): AdaptiveAvgPool2d(output_size=(7, 7))
  (classifier): Sequential(
    (0): Linear(in_features=25088, out_features=4096, bias=True)
    (1): ReLU(inplace=True)
    (2): Dropout(p=0.5, inplace=False)
    (3): Linear(in_features=4096, out_features=4096, bias=True)
    (4): ReLU(inplace=True)
    (5): Dropout(p=0.5, inplace=False)
    (6): Linear(in_features=4096, out_features=1000, bias=True)
  )
)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">input_image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">summary</span><span class="p">(</span><span class="n">vgg16</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">*</span><span class="n">input_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>==========================================================================================
Layer (type:depth-idx)                   Output Shape              Param #
==========================================================================================
VGG                                      --                        --
├─Sequential: 1-1                        [1, 512, 25, 25]          --
│    └─Conv2d: 2-1                       [1, 64, 800, 800]         1,792
│    └─ReLU: 2-2                         [1, 64, 800, 800]         --
│    └─Conv2d: 2-3                       [1, 64, 800, 800]         36,928
│    └─ReLU: 2-4                         [1, 64, 800, 800]         --
│    └─MaxPool2d: 2-5                    [1, 64, 400, 400]         --
│    └─Conv2d: 2-6                       [1, 128, 400, 400]        73,856
│    └─ReLU: 2-7                         [1, 128, 400, 400]        --
│    └─Conv2d: 2-8                       [1, 128, 400, 400]        147,584
│    └─ReLU: 2-9                         [1, 128, 400, 400]        --
│    └─MaxPool2d: 2-10                   [1, 128, 200, 200]        --
│    └─Conv2d: 2-11                      [1, 256, 200, 200]        295,168
│    └─ReLU: 2-12                        [1, 256, 200, 200]        --
│    └─Conv2d: 2-13                      [1, 256, 200, 200]        590,080
│    └─ReLU: 2-14                        [1, 256, 200, 200]        --
│    └─Conv2d: 2-15                      [1, 256, 200, 200]        590,080
│    └─ReLU: 2-16                        [1, 256, 200, 200]        --
│    └─MaxPool2d: 2-17                   [1, 256, 100, 100]        --
│    └─Conv2d: 2-18                      [1, 512, 100, 100]        1,180,160
│    └─ReLU: 2-19                        [1, 512, 100, 100]        --
│    └─Conv2d: 2-20                      [1, 512, 100, 100]        2,359,808
│    └─ReLU: 2-21                        [1, 512, 100, 100]        --
│    └─Conv2d: 2-22                      [1, 512, 100, 100]        2,359,808
│    └─ReLU: 2-23                        [1, 512, 100, 100]        --
│    └─MaxPool2d: 2-24                   [1, 512, 50, 50]          --
│    └─Conv2d: 2-25                      [1, 512, 50, 50]          2,359,808
│    └─ReLU: 2-26                        [1, 512, 50, 50]          --
│    └─Conv2d: 2-27                      [1, 512, 50, 50]          2,359,808
│    └─ReLU: 2-28                        [1, 512, 50, 50]          --
│    └─Conv2d: 2-29                      [1, 512, 50, 50]          2,359,808
│    └─ReLU: 2-30                        [1, 512, 50, 50]          --
│    └─MaxPool2d: 2-31                   [1, 512, 25, 25]          --
├─AdaptiveAvgPool2d: 1-2                 [1, 512, 7, 7]            --
├─Sequential: 1-3                        [1, 1000]                 --
│    └─Linear: 2-32                      [1, 4096]                 102,764,544
│    └─ReLU: 2-33                        [1, 4096]                 --
│    └─Dropout: 2-34                     [1, 4096]                 --
│    └─Linear: 2-35                      [1, 4096]                 16,781,312
│    └─ReLU: 2-36                        [1, 4096]                 --
│    └─Dropout: 2-37                     [1, 4096]                 --
│    └─Linear: 2-38                      [1, 1000]                 4,097,000
==========================================================================================
Total params: 138,357,544
Trainable params: 138,357,544
Non-trainable params: 0
Total mult-adds (G): 196.04
==========================================================================================
Input size (MB): 7.68
Forward/backward pass size (MB): 1382.47
Params size (MB): 553.43
Estimated Total Size (MB): 1943.58
==========================================================================================
</code></pre></div>
<ul>
<li>Basically we are taking the feature maps up until the last conv layer (exclude max pool). This is a typical step where by we cut off at the final conv layer to get the feature maps!</li>
<li>We just subset all features from conv2d 2-1 to relu 2-30 which is just subset [0:-1] from vgg16 features method.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">req_features</span> <span class="o">=</span> <span class="n">vgg16</span><span class="o">.</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Convert this list into a Sequential module, </span>
<span class="n">faster_rcnn_fe_extractor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">req_features</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># 測試看看 input image 通過 feature extractor 的結果</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()])</span> <span class="c1"># Defing PyTorch Transform</span>
<span class="n">imgTensor</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">img_resized</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> 
<span class="n">imgTensor</span> <span class="o">=</span> <span class="n">imgTensor</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">out_map</span> <span class="o">=</span> <span class="n">faster_rcnn_fe_extractor</span><span class="p">(</span><span class="n">imgTensor</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">out_map</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>torch.Size([1, 512, 50, 50])
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># visualize the first 5 channels of the 50*50*512 feature maps</span>
<span class="n">imgArray</span><span class="o">=</span><span class="n">out_map</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">figNo</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span> 
    <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figNo</span><span class="p">)</span> 
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imgArray</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">figNo</span> <span class="o">+=</span><span class="mi">1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span>
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_22_0.png" /></p>
<h2 id="generate-anchor-boxes-on-each-input-image">Generate Anchor Boxes on Each Input Image</h2>
<ul>
<li>50x50=2500 anchors, each anchor generate 9 anchor boxes, Total = 50x50x9=22,500</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># x, y intervals to generate anchor box center</span>
<span class="n">fe_size</span> <span class="o">=</span> <span class="mi">800</span> <span class="o">//</span> <span class="mi">16</span> <span class="c1"># 50</span>
<span class="n">ctr_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="p">(</span><span class="n">fe_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="n">ctr_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="p">(</span><span class="n">fe_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ctr_x</span><span class="p">),</span> <span class="n">ctr_x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ctr_y</span><span class="p">),</span> <span class="n">ctr_y</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>50 [ 16  32  48  64  80  96 112 128 144 160 176 192 208 224 240 256 272 288
 304 320 336 352 368 384 400 416 432 448 464 480 496 512 528 544 560 576
 592 608 624 640 656 672 688 704 720 736 752 768 784 800]
50 [ 16  32  48  64  80  96 112 128 144 160 176 192 208 224 240 256 272 288
 304 320 336 352 368 384 400 416 432 448 464 480 496 512 528 544 560 576
 592 608 624 640 656 672 688 704 720 736 752 768 784 800]
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># coordinates of the 2500 center points to generate anchor boxes</span>
<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2500</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ctr_x</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ctr_y</span><span class="p">)):</span>
        <span class="n">ctr</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctr_x</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-</span> <span class="mi">8</span>
        <span class="n">ctr</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctr_y</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="mi">8</span>
        <span class="n">index</span> <span class="o">+=</span><span class="mi">1</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ctr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(2500, 2)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># display the 2500 anchors</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ctr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">img_resized</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ctr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ctr</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])),</span> <span class="n">radius</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_resized</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span>
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_27_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="c1"># for each of the 2500 anchors, generate 9 anchor boxes</span>
<span class="c1"># 2500*9 = 22500 anchor boxes</span>
<span class="n">ratios</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">scales</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">]</span>
<span class="n">sub_sample</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">anchor_boxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">((</span><span class="n">fe_size</span> <span class="o">*</span> <span class="n">fe_size</span> <span class="o">*</span> <span class="mi">9</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ctr</span><span class="p">:</span>
    <span class="n">ctr_y</span><span class="p">,</span> <span class="n">ctr_x</span> <span class="o">=</span> <span class="n">c</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratios</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scales</span><span class="p">)):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">sub_sample</span> <span class="o">*</span> <span class="n">scales</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ratios</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">sub_sample</span> <span class="o">*</span> <span class="n">scales</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span> <span class="n">ratios</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">anchor_boxes</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctr_y</span> <span class="o">-</span> <span class="n">h</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">anchor_boxes</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctr_x</span> <span class="o">-</span> <span class="n">w</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">anchor_boxes</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctr_y</span> <span class="o">+</span> <span class="n">h</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">anchor_boxes</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctr_x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="nb">print</span><span class="p">(</span><span class="n">anchor_boxes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(22500, 4)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_anchor_boxes</span><span class="p">(</span>
    <span class="n">anchor_boxes</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">anchor_bboxes_range</span><span class="p">:</span> <span class="n">Callable</span>
<span class="p">):</span>
    <span class="n">image_clone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="c1"># display the 9 anchor boxes of one anchor and the ground truth bbox</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">anchor_bboxes_range</span><span class="p">:</span>  <span class="c1"># 9*1225=11025</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anchor_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anchor_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anchor_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anchor_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
            <span class="n">image_clone</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">3</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bboxes</span><span class="p">)):</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
            <span class="n">image_clone</span><span class="p">,</span>
            <span class="p">(</span><span class="n">bboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">bboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
            <span class="p">(</span><span class="n">bboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">bboxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span>
            <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">thickness</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># Draw Rectangle</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_clone</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">anchor_bboxes_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">plot_anchor_boxes</span><span class="p">(</span><span class="n">anchor_boxes</span><span class="p">,</span> <span class="n">bboxes_resized</span><span class="p">,</span> <span class="n">img_resized</span><span class="p">,</span> <span class="n">anchor_bboxes_range</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_30_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">anchor_bboxes_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span>
<span class="n">plot_anchor_boxes</span><span class="p">(</span><span class="n">anchor_boxes</span><span class="p">,</span> <span class="n">bboxes_resized</span><span class="p">,</span> <span class="n">img_resized</span><span class="p">,</span> <span class="n">anchor_bboxes_range</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_31_0.png" /></p>
<ul>
<li>This 9 anchor boxes are the centered around the center pixel.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">anchor_bboxes_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11025</span><span class="p">,</span> <span class="mi">11034</span><span class="p">)</span> <span class="c1">#9*1225=11025 middle pixel&#39;s anchor box</span>
<span class="n">plot_anchor_boxes</span><span class="p">(</span><span class="n">anchor_boxes</span><span class="p">,</span> <span class="n">bboxes_resized</span><span class="p">,</span> <span class="n">img_resized</span><span class="p">,</span> <span class="n">anchor_bboxes_range</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_33_0.png" /></p>
<ul>
<li>Out of 22500 anchor boxes, we need to discard some anchor boxes, because due to the generating algorithm, some anchor boxes might be outside of the 800 by 800 image.</li>
<li>After discarding we have 8940 anchor boxes left.</li>
<li>I believe if you tune the <code>ratios = [0.5, 1, 2]</code> and <code>scales = [8, 16, 32]</code> you will get different results for valid anchor boxes.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Ignore cross-boundary anchor boxes</span>
<span class="c1"># valid anchor boxes with (y1, x1)&gt;0 and (y2, x2)&lt;=800</span>
<span class="n">index_inside</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="p">(</span><span class="n">anchor_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">anchor_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">anchor_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">800</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">anchor_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">800</span><span class="p">)</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">index_inside</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">valid_anchor_boxes</span> <span class="o">=</span> <span class="n">anchor_boxes</span><span class="p">[</span><span class="n">index_inside</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">valid_anchor_boxes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(8940,)
(8940, 4)
</code></pre></div>
<h2 id="iou-of-anchor-box-and-true-bounding-boxes">IOU of Anchor Box and True Bounding Boxes!</h2>
<p><img alt="image.png" src="attachment:8d633915-ce2d-42c6-a78b-5a361abe844f.png" /></p>
<ul>
<li>Calculate iou of the valid anchor boxes with each ground truth bbox.</li>
<li>Since there are 8940 valid anchor boxes and only 2 ground truth bbox per this image, then </li>
<li>Our final <code>ious</code> should be an array of (8940, 2) where column 1 is the ious of each anchor box with bbox 1 (dog gt bbox) and column 2 is the ious of each anchor box with bbox 2 (the cat gt bbox)</li>
<li>Note this is batch size of 1, so it is easy to see, but in reality each image has different number of gt bboxes! So take note the shape won't always be (8940, 2)</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Calculate iou of the valid anchor boxes </span>
<span class="c1"># Since we have 8940 anchor boxes and 2 ground truth objects, we should get an array with (8490, 2) as the output. </span>
<span class="n">ious</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_anchor_boxes</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">ious</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">num1</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">valid_anchor_boxes</span><span class="p">):</span>
    <span class="n">ya1</span><span class="p">,</span> <span class="n">xa1</span><span class="p">,</span> <span class="n">ya2</span><span class="p">,</span> <span class="n">xa2</span> <span class="o">=</span> <span class="n">i</span>  
    <span class="n">anchor_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">ya2</span> <span class="o">-</span> <span class="n">ya1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">xa2</span> <span class="o">-</span> <span class="n">xa1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">num2</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bboxes_resized</span><span class="p">):</span>
        <span class="n">yb1</span><span class="p">,</span> <span class="n">xb1</span><span class="p">,</span> <span class="n">yb2</span><span class="p">,</span> <span class="n">xb2</span> <span class="o">=</span> <span class="n">j</span>
        <span class="n">box_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">yb2</span><span class="o">-</span> <span class="n">yb1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">xb2</span> <span class="o">-</span> <span class="n">xb1</span><span class="p">)</span>
        <span class="n">inter_x1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">xb1</span><span class="p">,</span> <span class="n">xa1</span><span class="p">])</span>
        <span class="n">inter_y1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">yb1</span><span class="p">,</span> <span class="n">ya1</span><span class="p">])</span>
        <span class="n">inter_x2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">xb2</span><span class="p">,</span> <span class="n">xa2</span><span class="p">])</span>
        <span class="n">inter_y2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">yb2</span><span class="p">,</span> <span class="n">ya2</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">inter_x1</span> <span class="o">&lt;</span> <span class="n">inter_x2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">inter_y1</span> <span class="o">&lt;</span> <span class="n">inter_y2</span><span class="p">):</span>
            <span class="n">iter_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">inter_y2</span> <span class="o">-</span> <span class="n">inter_y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">inter_x2</span> <span class="o">-</span> <span class="n">inter_x1</span><span class="p">)</span>
            <span class="n">iou</span> <span class="o">=</span> <span class="n">iter_area</span> <span class="o">/</span> <span class="p">(</span><span class="n">anchor_area</span><span class="o">+</span> <span class="n">box_area</span> <span class="o">-</span> <span class="n">iter_area</span><span class="p">)</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iou</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">ious</span><span class="p">[</span><span class="n">num1</span><span class="p">,</span> <span class="n">num2</span><span class="p">]</span> <span class="o">=</span> <span class="n">iou</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ious</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(8940, 2)
</code></pre></div>
<ul>
<li>For eg, [0.01919497, 0] means the cat bbox and the anchor bbox has 0 intersection.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">ious</span> 
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([[0.01919497, 0.        ],
       [0.02159903, 0.        ],
       [0.02401446, 0.        ],
       ...,
       [0.        , 0.0157947 ],
       [0.        , 0.01381642],
       [0.        , 0.01184583]], dtype=float32)
</code></pre></div>
<ul>
<li>gt_argmax_ious: at row 1850 and 6846, we note that they have the highest IOU. We used <code>argmax</code> on the axis 0 column wise, means for each column, we find out which index has the highest IOU score.</li>
<li>gt_max_ious: We put these two max ious (1 for dog 1 for cat) into an array [0.886.., 0.581..]</li>
<li>gt_argmax_ious: We further see if there's other indexes with the highest IOUs because there can be tie when you use argmax.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># What anchor box has max iou with the ground truth bbox</span>
<span class="n">gt_argmax_ious</span> <span class="o">=</span> <span class="n">ious</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gt_argmax_ious</span><span class="p">)</span>

<span class="n">gt_max_ious</span> <span class="o">=</span> <span class="n">ious</span><span class="p">[</span><span class="n">gt_argmax_ious</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ious</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gt_max_ious</span><span class="p">)</span>

<span class="n">gt_argmax_ious</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ious</span> <span class="o">==</span> <span class="n">gt_max_ious</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gt_argmax_ious</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[1850 6846]
[0.8863183 0.5810547]
[1850 1857 1864 1871 2078 2085 2092 2099 6846 6853 6860 6867 7074 7081
 7088 7095 7302 7309 7316 7323 7530 7537 7544 7551 7758 7765 7772 7779]
</code></pre></div>
<ul>
<li>argmax_ious: this means for each row, we compare the two IOUs and take the largest IOU, then assign to the index:</li>
<li>For example the first 3 rows of ious are
<div class="highlight"><pre><span></span><code><span class="p">([[</span><span class="mf">0.01919497</span><span class="p">,</span> <span class="mf">0.</span>        <span class="p">],</span>
   <span class="p">[</span><span class="mf">0.02159903</span><span class="p">,</span> <span class="mf">0.</span>        <span class="p">],</span>
   <span class="p">[</span><span class="mf">0.02401446</span><span class="p">,</span> <span class="mf">0.</span>        <span class="p">],</span>
</code></pre></div></li>
</ul>
<p>note each row is the anchor box IOU with the 2 gt, so for 1st row, the anchor bbox has some iou with dog as compared to the iou of it with the cat bbox, so we take the index to be 0, else index is 1.</p>
<ul>
<li>max_ious: take the highest IOU for each row and reduce it to 1 column.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># What ground truth bbox is associated with each anchor box </span>
<span class="n">argmax_ious</span> <span class="o">=</span> <span class="n">ious</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">argmax_ious</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">argmax_ious</span><span class="p">)</span>
<span class="n">max_ious</span> <span class="o">=</span> <span class="n">ious</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index_inside</span><span class="p">)),</span> <span class="n">argmax_ious</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">max_ious</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(8940,)
[0 0 0 ... 1 1 1]
[0.01919497 0.02159903 0.02401446 ... 0.0157947  0.01381642 0.01184583]
</code></pre></div>
<ul>
<li>Let us plot some of these anchor boxes!! Note we change the input argument to <code>valid_anchor_boxes</code> now since we are looking at the valid ones.</li>
<li>Let us plot 1850's anchor box by specifying the range from 1850 - 1851. Lo and behold the dog highest bbox is indeed quite good.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">anchor_bboxes_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1850</span><span class="p">,</span> <span class="mi">1851</span><span class="p">)</span> <span class="c1">#9*1225=11025 middle pixel&#39;s anchor box</span>
<span class="n">plot_anchor_boxes</span><span class="p">(</span><span class="n">valid_anchor_boxes</span><span class="p">,</span> <span class="n">bboxes_resized</span><span class="p">,</span> <span class="n">img_resized</span><span class="p">,</span> <span class="n">anchor_bboxes_range</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_47_0.png" /></p>
<ul>
<li>Let us plot some of these anchor boxes!! Note we change the input argument to <code>valid_anchor_boxes</code> now since we are looking at the valid ones.</li>
<li>Let us plot 6846's anchor box by specifying the range from 6846 - 6847. Lo and behold! The cat highest bbox isnt as good but ok.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">anchor_bboxes_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6846</span><span class="p">,</span> <span class="mi">6847</span><span class="p">)</span> <span class="c1">#9*1225=11025 middle pixel&#39;s anchor box</span>
<span class="n">plot_anchor_boxes</span><span class="p">(</span><span class="n">valid_anchor_boxes</span><span class="p">,</span> <span class="n">bboxes_resized</span><span class="p">,</span> <span class="n">img_resized</span><span class="p">,</span> <span class="n">anchor_bboxes_range</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_49_0.png" /></p>
<h2 id="use-the-iou-value-to-assign-labels-to-each-valid-anchor-box-important">Use the IOU value to assign <strong>LABELS</strong> TO EACH VALID ANCHOR BOX (<strong>IMPORTANT</strong>)</h2>
<ul>
<li>See D2L:</li>
<li>Using the c (512) length- feature vector at the center of each anchor box, predict the binary class (background or objects) and bounding box for this anchor box.</li>
<li>So, if IOU is more than a threshold say 0.7, then it is an object which we assign 1, if less than say 0.3, then assign it as background 0, and if between 0.3 and 0.7 we ignore and assign -1.</li>
</ul>
<blockquote>
<p>This step is important and clears confusion of how <strong>labels</strong> were assigned to each anchor box very important!</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1"># 把 8940 個 valid anchor boxes 的標籤先統一設為 -1 (ignore)</span>
<span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">index_inside</span><span class="p">),</span> <span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">label</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(8940,)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Use iou to assign 1 (objects) to two kind of anchors </span>
<span class="c1"># a) The anchors with the highest iou overlap with a ground-truth-box</span>
<span class="c1"># b) An anchor that has an IoU overlap higher than 0.7 with ground-truth box</span>

<span class="c1"># Assign 0 (background) to an anchor if its IoU ratio is lower than 0.3 for all ground-truth boxes</span>
<span class="n">pos_iou_threshold</span>  <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">neg_iou_threshold</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">label</span><span class="p">[</span><span class="n">gt_argmax_ious</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">label</span><span class="p">[</span><span class="n">max_ious</span> <span class="o">&gt;=</span> <span class="n">pos_iou_threshold</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">label</span><span class="p">[</span><span class="n">max_ious</span> <span class="o">&lt;</span> <span class="n">neg_iou_threshold</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>
<p>We see that there are only a few anchor boxes left that really has an object, the rest is background or ignore.</p>
<div class="highlight"><pre><span></span><code><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">label</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(array([1394, 1401, 1408, 1415, 1622, 1629, 1636, 1643, 1850, 1857, 1864,
        1871, 2078, 2085, 2092, 2099, 2314, 2322, 2330, 2338, 2560, 2568,
        2576, 2584, 6846, 6853, 6860, 6867, 7074, 7081, 7088, 7095, 7302,
        7309, 7316, 7323, 7530, 7537, 7544, 7551, 7758, 7765, 7772, 7779],
       dtype=int64),)
</code></pre></div>
<h2 id="mini-batch-256">Mini-Batch 256</h2>
<ul>
<li>Batch size 256 this is not the batch size of the image but batch size of the anchor boxes</li>
<li>So there are 8940 valid anchor boxes, we take 256 from them randomly and such that 128 of them are object of 1 and 128 to be background 0 and the remaining is -1</li>
<li>Note that I only have 44 valid anchor boxes with "object" 1 that's ok, we just label all others to be -1.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">n_sample</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">pos_ratio</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">n_pos</span> <span class="o">=</span> <span class="n">pos_ratio</span> <span class="o">*</span> <span class="n">n_sample</span>

<span class="n">pos_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">label</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_pos</span><span class="p">:</span>
    <span class="n">disable_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">pos_index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos_index</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_pos</span><span class="p">),</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">label</span><span class="p">[</span><span class="n">disable_index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<span class="n">n_neg</span> <span class="o">=</span> <span class="n">n_sample</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">label</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">neg_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">label</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">neg_index</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n_neg</span><span class="p">:</span>
    <span class="n">disable_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">neg_index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">neg_index</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_neg</span><span class="p">),</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">label</span><span class="p">[</span><span class="n">disable_index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(7842,)
</code></pre></div>
<h2 id="transform-valid-anchor-boxes-format-from-y1-x1-y2-x2-to-the-correct-format">Transform Valid Anchor Boxes Format from (y1, x1, y2, x2) to the correct format</h2>
<div class="highlight"><pre><span></span><code><span class="c1"># For each valid anchor box, find the groundtruth object which has max_iou </span>
<span class="n">max_iou_bbox</span> <span class="o">=</span> <span class="n">bboxes_resized</span><span class="p">[</span><span class="n">argmax_ious</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">max_iou_bbox</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># valid anchor boxes 的 h, w, cx, cy </span>
<span class="n">height</span> <span class="o">=</span> <span class="n">valid_anchor_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">valid_anchor_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">width</span> <span class="o">=</span> <span class="n">valid_anchor_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">valid_anchor_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">ctr_y</span> <span class="o">=</span> <span class="n">valid_anchor_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">height</span>
<span class="n">ctr_x</span> <span class="o">=</span> <span class="n">valid_anchor_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">width</span>

<span class="c1"># valid anchor box 的 max iou 的 bbox 的 h, w, cx, cy </span>
<span class="n">base_height</span> <span class="o">=</span> <span class="n">max_iou_bbox</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_iou_bbox</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">base_width</span> <span class="o">=</span> <span class="n">max_iou_bbox</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_iou_bbox</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">base_ctr_y</span> <span class="o">=</span> <span class="n">max_iou_bbox</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">base_height</span>
<span class="n">base_ctr_x</span> <span class="o">=</span> <span class="n">max_iou_bbox</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">base_width</span>

<span class="c1"># valid anchor boxes 的 loc = (y-ya/ha), (x-xa/wa), log(h/ha), log(w/wa)</span>
<span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">height</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
<span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span> <span class="c1">#讓 height !=0, 最小值為 eps</span>
<span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
<span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_ctr_y</span> <span class="o">-</span> <span class="n">ctr_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">height</span>
<span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_ctr_x</span> <span class="o">-</span> <span class="n">ctr_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span>
<span class="n">dh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">base_height</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span>
<span class="n">dw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">base_width</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span>
<span class="n">anchor_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dh</span><span class="p">,</span> <span class="n">dw</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">anchor_locs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(8940, 4)
(8940, 4)
</code></pre></div>
<h2 id="region-proposal-network">Region Proposal Network</h2>
<ul>
<li>So now we must be clear, we have labelled 8940 valid anchor boxes with the <strong>TRUE ANSWER Y</strong> labels: i.e. some have object we give it a binary class of 1 some dont have we give it 0, some we want to ignore we give it -1</li>
<li>So now back to our 22500 anchor boxes, we label all the "invalid anchor bboxes" to be -1 also cause we want to ignore them as well.</li>
<li>Note that we are in a mini-batch of 256 anchor boxes so our RPN focuses on this 256 for now.</li>
<li>See image below the <span class="arithmatex">\(y\)</span> and <span class="arithmatex">\(\hat{y}\)</span> indicates the gt and predicted.</li>
</ul>
<p><img alt="img2.png" src="attachment:7e05d3d7-a702-448e-b5bd-02861fdf5c60.png" /></p>
<ul>
<li>NOTICE: 每個 training epoch, 我們從 8940 個 valid anchor boxes 隨機選 128 個 positive + 128個 negative, 其他都標-1</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">anchor_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">anchor_boxes</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">label</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">anchor_labels</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">anchor_labels</span><span class="p">[</span><span class="n">index_inside</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
<span class="nb">print</span><span class="p">(</span><span class="n">anchor_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">anchor_locations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">anchor_boxes</span><span class="p">),)</span> <span class="o">+</span> <span class="n">anchor_boxes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">anchor_locs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">anchor_locations</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">anchor_locations</span><span class="p">[</span><span class="n">index_inside</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">anchor_locs</span>
<span class="nb">print</span><span class="p">(</span><span class="n">anchor_locations</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(22500,)
(22500, 4)
</code></pre></div>
<h3 id="send-feature-maps-to-rpn-to-produce-22500-regions-of-interests-rois">Send Feature Maps to RPN to produce 22500 Regions of Interests (ROIs)</h3>
<ul>
<li>Send the feature maps to the RPN</li>
<li>Recall <code>out_map = faster_rcnn_fe_extractor(imgTensor)</code> where we already send the image tensor through the feature extractor and has shape of <code>[1, 512, 50, 50]</code>.</li>
<li>So now we will concat some layers after the feature map <code>out_map</code>.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">out_map</span> <span class="o">=</span> <span class="n">faster_rcnn_fe_extractor</span><span class="p">(</span><span class="n">imgTensor</span><span class="p">)</span>
<span class="n">out_map</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>torch.Size([1, 512, 50, 50])
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">in_channels</span> <span class="o">=</span> <span class="mi">512</span>  <span class="c1"># depends on the output feature map. in vgg 16 it is equal to 512</span>

<span class="n">mid_channels</span> <span class="o">=</span> <span class="mi">512</span>
<span class="n">n_anchor</span> <span class="o">=</span> <span class="mi">9</span>  <span class="c1"># Number of anchors at each location</span>

<span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">mid_channels</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">conv1</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">conv1</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>

<span class="n">reg_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">mid_channels</span><span class="p">,</span> <span class="n">n_anchor</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">reg_layer</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">reg_layer</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span>

<span class="n">cls_layer</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">mid_channels</span><span class="p">,</span> <span class="n">n_anchor</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># I will be going to use softmax here. you can equally use sigmoid if u replace 2 with 1.</span>
<span class="n">cls_layer</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">normal_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">cls_layer</span><span class="o">.</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">zero_</span><span class="p">();</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">conv1</span><span class="p">(</span><span class="n">out_map</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span> <span class="c1"># out_map = faster_rcnn_fe_extractor(imgTensor)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">pred_anchor_locs</span> <span class="o">=</span> <span class="n">reg_layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">pred_cls_scores</span> <span class="o">=</span> <span class="n">cls_layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pred_anchor_locs</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">pred_cls_scores</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>torch.Size([1, 512, 50, 50])
torch.Size([1, 36, 50, 50]) torch.Size([1, 18, 50, 50])
</code></pre></div>
<ul>
<li>
<p><code>reg_layer</code>: has 9*4 = 36 filters in this layer and therefore outputs [1, 36, 50, 50] shape since padding is same with stride 1.</p>
<ul>
<li>because recall there are 2500 anchors points (not boxes), and there are 2500 * 9 = 22500 anchor boxes, so each anchor box has 4 values so this can be reshaped from (36, 50, 50) to (22500, 4), which is exactly what we want for the regression layer to calculate the loss of localization of the predicted anchor boxes from RPN vs true anchor boxes.</li>
</ul>
</li>
<li>
<p><code>cls_layer</code>: in turn this has only [1, 18, 50, 50] shape because it can be reshaped to [22500, 2] since we only want binary classification from RPN to predict whether there exist an object 1 or not 0.</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 轉換 RPN 預測 anchor box 的位置與分類之 format </span>
<span class="c1"># 位置: [1, 36(9*4), 50, 50] =&gt; [1, 22500(50*50*9), 4] (dy, dx, dh, dw)</span>
<span class="c1"># 分類: [1, 18(9*2), 50, 50] =&gt; [1, 22500, 2]  (1, 0)</span>
<span class="n">pred_anchor_locs</span> <span class="o">=</span> <span class="n">pred_anchor_locs</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pred_anchor_locs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">pred_cls_scores</span> <span class="o">=</span> <span class="n">pred_cls_scores</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pred_cls_scores</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">objectness_score</span> <span class="o">=</span> <span class="n">pred_cls_scores</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">objectness_score</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">pred_cls_scores</span>  <span class="o">=</span> <span class="n">pred_cls_scores</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pred_cls_scores</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>torch.Size([1, 22500, 4])
torch.Size([1, 50, 50, 18])
torch.Size([1, 22500])
torch.Size([1, 22500, 2])
</code></pre></div>
<h3 id="rpn-loss">RPN LOSS</h3>
<ul>
<li>Localization loss uses regression with smooth L1 Loss</li>
<li>Objectness Classification uses CE Loss</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">pred_anchor_locs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pred_cls_scores</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">anchor_locations</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">anchor_labels</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>torch.Size([1, 22500, 4])
torch.Size([1, 22500, 2])
(22500, 4)
(22500,)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">rpn_loc</span> <span class="o">=</span> <span class="n">pred_anchor_locs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rpn_score</span> <span class="o">=</span> <span class="n">pred_cls_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">gt_rpn_loc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">anchor_locations</span><span class="p">)</span>
<span class="n">gt_rpn_score</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">anchor_labels</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">rpn_loc</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">rpn_score</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">gt_rpn_loc</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">gt_rpn_score</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>torch.Size([22500, 4]) torch.Size([22500, 2]) torch.Size([22500, 4]) torch.Size([22500])
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># For classification we use cross-entropy loss</span>
<span class="n">rpn_cls_loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">rpn_score</span><span class="p">,</span> <span class="n">gt_rpn_score</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">ignore_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rpn_cls_loss</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>tensor(0.7012, grad_fn=&lt;NllLossBackward0&gt;)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># For Regression we use smooth L1 loss as defined in the Fast RCNN paper</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">gt_rpn_score</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">rpn_loc</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># take those bounding boxes which have positve labels</span>
<span class="n">mask_loc_preds</span> <span class="o">=</span> <span class="n">rpn_loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">mask_loc_targets</span> <span class="o">=</span> <span class="n">gt_rpn_loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mask_loc_preds</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">mask_loc_targets</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mask_loc_targets</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span> <span class="o">-</span> <span class="n">mask_loc_preds</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>
<span class="n">rpn_loc_loss</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mf">0.5</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rpn_loc_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>torch.Size([22500, 4])
torch.Size([44, 4]) torch.Size([44, 4])
tensor(1.2859, dtype=torch.float64, grad_fn=&lt;SumBackward0&gt;)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Combining both the rpn_cls_loss and rpn_reg_loss</span>
<span class="n">rpn_lambda</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="n">N_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">gt_rpn_score</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">rpn_loc_loss</span> <span class="o">=</span> <span class="n">rpn_loc_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">N_reg</span>
<span class="n">rpn_loss</span> <span class="o">=</span> <span class="n">rpn_cls_loss</span> <span class="o">+</span> <span class="p">(</span><span class="n">rpn_lambda</span> <span class="o">*</span> <span class="n">rpn_loc_loss</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rpn_loss</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>tensor(0.9935, dtype=torch.float64, grad_fn=&lt;AddBackward0&gt;)
</code></pre></div>
<h2 id="nms">NMS</h2>
<div class="highlight"><pre><span></span><code><span class="n">nms_thresh</span> <span class="o">=</span> <span class="mf">0.7</span>  <span class="c1"># non-maximum supression (NMS) </span>
<span class="n">n_train_pre_nms</span> <span class="o">=</span> <span class="mi">12000</span> <span class="c1"># no. of train pre-NMS</span>
<span class="n">n_train_post_nms</span> <span class="o">=</span> <span class="mi">2000</span> <span class="c1"># after nms, training Fast R-CNN using 2000 RPN proposals</span>
<span class="n">n_test_pre_nms</span> <span class="o">=</span> <span class="mi">6000</span>
<span class="n">n_test_post_nms</span> <span class="o">=</span> <span class="mi">300</span> <span class="c1"># During testing we evaluate 300 proposals,</span>
<span class="n">min_size</span> <span class="o">=</span> <span class="mi">16</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># The labelled 22500 anchor boxes </span>
<span class="c1"># format converted from [y1, x1, y2, x2] to [ctr_x, ctr_y, h, w]</span>
<span class="n">anc_height</span> <span class="o">=</span> <span class="n">anchor_boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">anchor_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">anc_width</span> <span class="o">=</span> <span class="n">anchor_boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">anchor_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">anc_ctr_y</span> <span class="o">=</span> <span class="n">anchor_boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">anc_height</span>
<span class="n">anc_ctr_x</span> <span class="o">=</span> <span class="n">anchor_boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">anc_width</span>
<span class="nb">print</span><span class="p">(</span><span class="n">anc_ctr_x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># The 22500 anchor boxes location and labels predicted by RPN (convert to numpy)</span>
<span class="c1"># format = (dy, dx, dh, dw)</span>
<span class="n">pred_anchor_locs_numpy</span> <span class="o">=</span> <span class="n">pred_anchor_locs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">objectness_score_numpy</span> <span class="o">=</span> <span class="n">objectness_score</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">dy</span> <span class="o">=</span> <span class="n">pred_anchor_locs_numpy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span> <span class="c1">#每個 anchor box 的 dy</span>
<span class="n">dx</span> <span class="o">=</span> <span class="n">pred_anchor_locs_numpy</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># dx</span>
<span class="n">dh</span> <span class="o">=</span> <span class="n">pred_anchor_locs_numpy</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># dh</span>
<span class="n">dw</span> <span class="o">=</span> <span class="n">pred_anchor_locs_numpy</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># dw</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dy</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># ctr_y = dy predicted by RPN * anchor_h + anchor_cy</span>
<span class="c1"># ctr_x similar</span>
<span class="c1"># h = exp(dh predicted by RPN) * anchor_h</span>
<span class="c1"># w similar</span>
<span class="n">ctr_y</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">anc_height</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">anc_ctr_y</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
<span class="n">ctr_x</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">anc_width</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">anc_ctr_x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dh</span><span class="p">)</span> <span class="o">*</span> <span class="n">anc_height</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">dw</span><span class="p">)</span> <span class="o">*</span> <span class="n">anc_width</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(22500,)
(22500, 1)
(22500, 1)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># 用 labelled 的 anchor boxes 與 RPN 預測的 anchor boxes來計算 ROI = [y1, x1, y2, x2] </span>
<span class="n">roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pred_anchor_locs_numpy</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">anchor_locs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">roi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctr_y</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">h</span>
<span class="n">roi</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctr_x</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">w</span>
<span class="n">roi</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctr_y</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">h</span>
<span class="n">roi</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">::</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctr_x</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">w</span>
<span class="nb">print</span><span class="p">(</span><span class="n">roi</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># clip the predicted boxes to the image</span>
<span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">)</span> <span class="c1">#Image size</span>
<span class="n">roi</span><span class="p">[:,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">roi</span><span class="p">[:,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">roi</span><span class="p">[:,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">roi</span><span class="p">[:,</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">roi</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">roi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">roi</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(22500, 4)
(22500, 4) 800.0 0.0
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Remove predicted boxes with either height or width &lt; threshold.</span>
<span class="n">hs</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">ws</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">roi</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">hs</span> <span class="o">&gt;=</span> <span class="n">min_size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ws</span> <span class="o">&gt;=</span> <span class="n">min_size</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#min_size=16</span>
<span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="n">keep</span><span class="p">,</span> <span class="p">:]</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">objectness_score_numpy</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">keep</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">roi</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">score</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Sort all (proposal, score) pairs by score from highest to lowest</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1">#Take top pre_nms_topN (e.g. 12000 while training and 300 while testing)</span>
<span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">[:</span><span class="n">n_train_pre_nms</span><span class="p">]</span>
<span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">roi</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">roi</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(22500,) (22500, 4) (22500,)
(22500,)
(12000,) (12000, 4) (12000, 4)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Take all the roi boxes [roi_array]</span>
<span class="n">y1</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">x1</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>

<span class="c1"># Find the areas of all the boxes [roi_area]</span>
<span class="n">areas</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">#Take the indexes of order the probability score in descending order </span>
<span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">keep</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">while</span> <span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#take the 1st elt in order and append to keep </span>
    <span class="n">keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">xx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x1</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span> 
    <span class="n">yy1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">y1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y1</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>
    <span class="n">xx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">x2</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>
    <span class="n">yy2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">y2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xx2</span> <span class="o">-</span> <span class="n">xx1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">yy2</span> <span class="o">-</span> <span class="n">yy1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">inter</span> <span class="o">=</span> <span class="n">w</span> <span class="o">*</span> <span class="n">h</span>
    <span class="n">ovr</span> <span class="o">=</span> <span class="n">inter</span> <span class="o">/</span> <span class="p">(</span><span class="n">areas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">areas</span><span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">-</span> <span class="n">inter</span><span class="p">)</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ovr</span> <span class="o">&lt;=</span> <span class="n">nms_thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">inds</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">keep</span> <span class="o">=</span> <span class="n">keep</span><span class="p">[:</span><span class="n">n_train_post_nms</span><span class="p">]</span> <span class="c1"># while training/testing , use accordingly</span>
<span class="n">roi</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span> <span class="c1"># the final region proposals</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keep</span><span class="p">),</span> <span class="n">roi</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>2000 (2000, 4)
</code></pre></div>
<h2 id="sample-128-from-nmss-2000-rois">Sample 128 From NMS's 2000 ROIs</h2>
<div class="highlight"><pre><span></span><code><span class="n">n_sample</span> <span class="o">=</span> <span class="mi">128</span>  <span class="c1"># Number of samples from roi </span>
<span class="n">pos_ratio</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="c1"># Number of positive examples out of the n_samples</span>
<span class="n">pos_iou_thresh</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Min iou of region proposal with any groundtruth object to consider it as positive label</span>
<span class="n">neg_iou_thresh_hi</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># iou 0~0.5 is considered as negative (0, background)</span>
<span class="n">neg_iou_thresh_lo</span> <span class="o">=</span> <span class="mf">0.0</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Find the iou of each ground truth object with the region proposals, </span>
<span class="n">ious</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">roi</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">ious</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">num1</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">roi</span><span class="p">):</span>
    <span class="n">ya1</span><span class="p">,</span> <span class="n">xa1</span><span class="p">,</span> <span class="n">ya2</span><span class="p">,</span> <span class="n">xa2</span> <span class="o">=</span> <span class="n">i</span>  
    <span class="n">anchor_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">ya2</span> <span class="o">-</span> <span class="n">ya1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">xa2</span> <span class="o">-</span> <span class="n">xa1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">num2</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bboxes_resized</span><span class="p">):</span>
        <span class="n">yb1</span><span class="p">,</span> <span class="n">xb1</span><span class="p">,</span> <span class="n">yb2</span><span class="p">,</span> <span class="n">xb2</span> <span class="o">=</span> <span class="n">j</span>
        <span class="n">box_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">yb2</span><span class="o">-</span> <span class="n">yb1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">xb2</span> <span class="o">-</span> <span class="n">xb1</span><span class="p">)</span>
        <span class="n">inter_x1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">xb1</span><span class="p">,</span> <span class="n">xa1</span><span class="p">])</span>
        <span class="n">inter_y1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">yb1</span><span class="p">,</span> <span class="n">ya1</span><span class="p">])</span>
        <span class="n">inter_x2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">xb2</span><span class="p">,</span> <span class="n">xa2</span><span class="p">])</span>
        <span class="n">inter_y2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">yb2</span><span class="p">,</span> <span class="n">ya2</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">inter_x1</span> <span class="o">&lt;</span> <span class="n">inter_x2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">inter_y1</span> <span class="o">&lt;</span> <span class="n">inter_y2</span><span class="p">):</span>
            <span class="n">iter_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">inter_y2</span> <span class="o">-</span> <span class="n">inter_y1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">inter_x2</span> <span class="o">-</span> <span class="n">inter_x1</span><span class="p">)</span>
            <span class="n">iou</span> <span class="o">=</span> <span class="n">iter_area</span> <span class="o">/</span> <span class="p">(</span><span class="n">anchor_area</span><span class="o">+</span> <span class="n">box_area</span> <span class="o">-</span> <span class="n">iter_area</span><span class="p">)</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iou</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">ious</span><span class="p">[</span><span class="n">num1</span><span class="p">,</span> <span class="n">num2</span><span class="p">]</span> <span class="o">=</span> <span class="n">iou</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ious</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(2000, 2)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Find out which ground truth has high IoU for each region proposal, Also find the maximum IoU</span>
<span class="n">gt_assignment</span> <span class="o">=</span> <span class="n">ious</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">max_iou</span> <span class="o">=</span> <span class="n">ious</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gt_assignment</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">max_iou</span><span class="p">)</span>

<span class="c1"># Assign the labels to each proposal</span>
<span class="n">gt_roi_label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">gt_assignment</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gt_roi_label</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[1 0 1 ... 0 0 0]
[0.16893381 0.         0.02414654 ... 0.280571   0.06312128 0.07249717]
[2 1 2 ... 1 1 1]
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Select the foreground rois as per the pos_iou_thesh and </span>
<span class="c1"># n_sample x pos_ratio (128 x 0.25 = 32) foreground samples.</span>
<span class="n">pos_roi_per_image</span> <span class="o">=</span> <span class="mi">32</span> 
<span class="n">pos_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_iou</span> <span class="o">&gt;=</span> <span class="n">pos_iou_thresh</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">pos_roi_per_this_image</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">pos_roi_per_image</span><span class="p">,</span> <span class="n">pos_index</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
<span class="k">if</span> <span class="n">pos_index</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">pos_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
        <span class="n">pos_index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">pos_roi_per_this_image</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pos_roi_per_this_image</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pos_index</span><span class="p">)</span>

<span class="c1"># Similarly we do for negitive (background) region proposals</span>
<span class="n">neg_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">max_iou</span> <span class="o">&lt;</span> <span class="n">neg_iou_thresh_hi</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="n">max_iou</span> <span class="o">&gt;=</span> <span class="n">neg_iou_thresh_lo</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">neg_roi_per_this_image</span> <span class="o">=</span> <span class="n">n_sample</span> <span class="o">-</span> <span class="n">pos_roi_per_this_image</span>
<span class="n">neg_roi_per_this_image</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">neg_roi_per_this_image</span><span class="p">,</span> <span class="n">neg_index</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
<span class="k">if</span>  <span class="n">neg_index</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
    <span class="n">neg_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
        <span class="n">neg_index</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">neg_roi_per_this_image</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">neg_roi_per_this_image</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">neg_index</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>25
[1586 1678 1453 1905  715 1738  395 1342  122   19  561  672 1591  136
 1640  347 1574  568  255 1779  199 1957 1736 1405 1609]
103
[ 534 1181 1987 1226  441  808  397   43  406 1372 1133 1332 1783  744
  824  939  562 1178 1089  595  558 1353 1470 1995  538  491  477 1224
 1208 1359  743 1799  674  290 1944  962 1806  681  192 1824  249 1452
  914  547   69  107  303 1304 1711 1986  911 1197  489 1033   94 1334
  806  187 1996  708 1657 1659 1688 1011 1196  225  403  509  282  401
  409  440   95  892 1321  133 1096  334  153 1923 1873  770 1291  734
  143 1680  475  418 1555 1950 1039 1382  298 1067 1965 1525 1255  330
  832 1485  212 1114 1487]
</code></pre></div>
<ul>
<li>Here displays ROI samples with positive class 1; meaning there is object.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># display ROI samples with postive </span>
<span class="n">img_clone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img_resized</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pos_roi_per_this_image</span><span class="p">):</span>
    <span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="n">pos_index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img_clone</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> 

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bboxes_resized</span><span class="p">)):</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img_clone</span><span class="p">,</span> <span class="p">(</span><span class="n">bboxes_resized</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">bboxes_resized</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">bboxes_resized</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">bboxes_resized</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># Draw Rectangle</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_clone</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span>
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_89_0.png" /></p>
<ul>
<li>Here displays ROI samples with negative class 0; meaning there is no object, background</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># display ROI samples with negative </span>
<span class="n">img_clone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img_resized</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">neg_roi_per_this_image</span><span class="p">):</span>
    <span class="n">y0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="n">neg_index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img_clone</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> 

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bboxes_resized</span><span class="p">)):</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img_clone</span><span class="p">,</span> <span class="p">(</span><span class="n">bboxes_resized</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">bboxes_resized</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">bboxes_resized</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">bboxes_resized</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># Draw Rectangle</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_clone</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span> 
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_91_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Now we gather positve samples index and negitive samples index, </span>
<span class="c1"># their respective labels and region proposals</span>

<span class="n">keep_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_index</span><span class="p">,</span> <span class="n">neg_index</span><span class="p">)</span>
<span class="n">gt_roi_labels</span> <span class="o">=</span> <span class="n">gt_roi_label</span><span class="p">[</span><span class="n">keep_index</span><span class="p">]</span>
<span class="n">gt_roi_labels</span><span class="p">[</span><span class="n">pos_roi_per_this_image</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># negative labels --&gt; 0</span>
<span class="n">sample_roi</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="n">keep_index</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sample_roi</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Pick the ground truth objects for these sample_roi and </span>
<span class="c1"># later parameterize as we have done while assigning locations to anchor boxes in section 2.</span>
<span class="n">bbox_for_sampled_roi</span> <span class="o">=</span> <span class="n">bboxes_resized</span><span class="p">[</span><span class="n">gt_assignment</span><span class="p">[</span><span class="n">keep_index</span><span class="p">]]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">bbox_for_sampled_roi</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">height</span> <span class="o">=</span> <span class="n">sample_roi</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">sample_roi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">width</span> <span class="o">=</span> <span class="n">sample_roi</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">sample_roi</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">ctr_y</span> <span class="o">=</span> <span class="n">sample_roi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">height</span>
<span class="n">ctr_x</span> <span class="o">=</span> <span class="n">sample_roi</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">width</span>

<span class="n">base_height</span> <span class="o">=</span> <span class="n">bbox_for_sampled_roi</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox_for_sampled_roi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">base_width</span> <span class="o">=</span> <span class="n">bbox_for_sampled_roi</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbox_for_sampled_roi</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">base_ctr_y</span> <span class="o">=</span> <span class="n">bbox_for_sampled_roi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">base_height</span>
<span class="n">base_ctr_x</span> <span class="o">=</span> <span class="n">bbox_for_sampled_roi</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">base_width</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(128, 4)
(128, 4)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">height</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
<span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
<span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>

<span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_ctr_y</span> <span class="o">-</span> <span class="n">ctr_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">height</span>
<span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_ctr_x</span> <span class="o">-</span> <span class="n">ctr_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span>
<span class="n">dh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">base_height</span> <span class="o">/</span> <span class="n">height</span><span class="p">)</span>
<span class="n">dw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">base_width</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span>

<span class="n">gt_roi_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dy</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dh</span><span class="p">,</span> <span class="n">dw</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gt_roi_locs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>(128, 4)
</code></pre></div>
<h2 id="128-roi-samples-features-and-pool-them">128 ROI Samples' Features and Pool them</h2>
<div class="highlight"><pre><span></span><code><span class="n">rois</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">sample_roi</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<span class="n">roi_indices</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rois</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">roi_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">roi_indices</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rois</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">roi_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">indices_and_rois</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">roi_indices</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">rois</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">xy_indices_and_rois</span> <span class="o">=</span> <span class="n">indices_and_rois</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>
<span class="n">indices_and_rois</span> <span class="o">=</span> <span class="n">xy_indices_and_rois</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">xy_indices_and_rois</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>torch.Size([128, 4]) torch.Size([128])
torch.Size([128, 5])
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">adaptive_max_pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveMaxPool2d</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">rois</span> <span class="o">=</span> <span class="n">indices_and_rois</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<span class="n">rois</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">16.0</span><span class="p">)</span> <span class="c1"># Subsampling ratio</span>
<span class="n">rois</span> <span class="o">=</span> <span class="n">rois</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
<span class="n">num_rois</span> <span class="o">=</span> <span class="n">rois</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_rois</span><span class="p">):</span>
    <span class="n">roi</span> <span class="o">=</span> <span class="n">rois</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">im_idx</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">out_map</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">im_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="n">roi</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">roi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]:(</span><span class="n">roi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">adaptive_max_pool</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">size</span><span class="p">());</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>torch.Size([128, 512, 7, 7])
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># Visualize the first 5 ROI&#39;s feature map (for each feature map, only show the 1st channel of d=512)</span>
<span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">figNo</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">roi</span> <span class="o">=</span> <span class="n">rois</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">im_idx</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">out_map</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">im_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="n">roi</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">roi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]:(</span><span class="n">roi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figNo</span><span class="p">)</span> 
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="n">figNo</span> <span class="o">+=</span><span class="mi">1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span>
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_98_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Visualize the first 5 ROI&#39;s feature maps after ROI pooling (for each feature map, only show the 1st channel of d=512)</span>
<span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">figNo</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">roi</span> <span class="o">=</span> <span class="n">rois</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">im_idx</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">out_map</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">im_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="n">roi</span><span class="p">[</span><span class="mi">2</span><span class="p">]:(</span><span class="n">roi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]:(</span><span class="n">roi</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">adaptive_max_pool</span><span class="p">(</span><span class="n">im</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figNo</span><span class="p">)</span> 
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="n">figNo</span> <span class="o">+=</span><span class="mi">1</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span>
</code></pre></div>
<p><img alt="png" src="../faster_rcnn_files/faster_rcnn_99_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Reshape the tensor so that we can pass it through the feed forward layer.</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># 25088 = 7*7*512</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>torch.Size([128, 25088])
</code></pre></div>
<h2 id="pytorch-pre-trained-model">PyTorch Pre-trained model</h2>
<div class="highlight"><pre><span></span><code><span class="n">model</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">detection</span><span class="o">.</span><span class="n">fasterrcnn_resnet50_fpn</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">model</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>FasterRCNN(
  (transform): GeneralizedRCNNTransform(
      Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225])
      Resize(min_size=(800,), max_size=1333, mode=&#39;bilinear&#39;)
  )
  (backbone): BackboneWithFPN(
    (body): IntermediateLayerGetter(
      (conv1): Conv2d(3, 64, kernel_size=(7, 7), stride=(2, 2), padding=(3, 3), bias=False)
      (bn1): FrozenBatchNorm2d(64, eps=0.0)
      (relu): ReLU(inplace=True)
      (maxpool): MaxPool2d(kernel_size=3, stride=2, padding=1, dilation=1, ceil_mode=False)
      (layer1): Sequential(
        (0): Bottleneck(
          (conv1): Conv2d(64, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(64, eps=0.0)
          (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(64, eps=0.0)
          (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(256, eps=0.0)
          (relu): ReLU(inplace=True)
          (downsample): Sequential(
            (0): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
            (1): FrozenBatchNorm2d(256, eps=0.0)
          )
        )
        (1): Bottleneck(
          (conv1): Conv2d(256, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(64, eps=0.0)
          (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(64, eps=0.0)
          (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(256, eps=0.0)
          (relu): ReLU(inplace=True)
        )
        (2): Bottleneck(
          (conv1): Conv2d(256, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(64, eps=0.0)
          (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(64, eps=0.0)
          (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(256, eps=0.0)
          (relu): ReLU(inplace=True)
        )
      )
      (layer2): Sequential(
        (0): Bottleneck(
          (conv1): Conv2d(256, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(128, eps=0.0)
          (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(128, eps=0.0)
          (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(512, eps=0.0)
          (relu): ReLU(inplace=True)
          (downsample): Sequential(
            (0): Conv2d(256, 512, kernel_size=(1, 1), stride=(2, 2), bias=False)
            (1): FrozenBatchNorm2d(512, eps=0.0)
          )
        )
        (1): Bottleneck(
          (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(128, eps=0.0)
          (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(128, eps=0.0)
          (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(512, eps=0.0)
          (relu): ReLU(inplace=True)
        )
        (2): Bottleneck(
          (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(128, eps=0.0)
          (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(128, eps=0.0)
          (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(512, eps=0.0)
          (relu): ReLU(inplace=True)
        )
        (3): Bottleneck(
          (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(128, eps=0.0)
          (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(128, eps=0.0)
          (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(512, eps=0.0)
          (relu): ReLU(inplace=True)
        )
      )
      (layer3): Sequential(
        (0): Bottleneck(
          (conv1): Conv2d(512, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(256, eps=0.0)
          (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(256, eps=0.0)
          (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(1024, eps=0.0)
          (relu): ReLU(inplace=True)
          (downsample): Sequential(
            (0): Conv2d(512, 1024, kernel_size=(1, 1), stride=(2, 2), bias=False)
            (1): FrozenBatchNorm2d(1024, eps=0.0)
          )
        )
        (1): Bottleneck(
          (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(256, eps=0.0)
          (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(256, eps=0.0)
          (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(1024, eps=0.0)
          (relu): ReLU(inplace=True)
        )
        (2): Bottleneck(
          (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(256, eps=0.0)
          (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(256, eps=0.0)
          (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(1024, eps=0.0)
          (relu): ReLU(inplace=True)
        )
        (3): Bottleneck(
          (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(256, eps=0.0)
          (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(256, eps=0.0)
          (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(1024, eps=0.0)
          (relu): ReLU(inplace=True)
        )
        (4): Bottleneck(
          (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(256, eps=0.0)
          (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(256, eps=0.0)
          (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(1024, eps=0.0)
          (relu): ReLU(inplace=True)
        )
        (5): Bottleneck(
          (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(256, eps=0.0)
          (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(256, eps=0.0)
          (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(1024, eps=0.0)
          (relu): ReLU(inplace=True)
        )
      )
      (layer4): Sequential(
        (0): Bottleneck(
          (conv1): Conv2d(1024, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(512, eps=0.0)
          (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(512, eps=0.0)
          (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(2048, eps=0.0)
          (relu): ReLU(inplace=True)
          (downsample): Sequential(
            (0): Conv2d(1024, 2048, kernel_size=(1, 1), stride=(2, 2), bias=False)
            (1): FrozenBatchNorm2d(2048, eps=0.0)
          )
        )
        (1): Bottleneck(
          (conv1): Conv2d(2048, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(512, eps=0.0)
          (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(512, eps=0.0)
          (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(2048, eps=0.0)
          (relu): ReLU(inplace=True)
        )
        (2): Bottleneck(
          (conv1): Conv2d(2048, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn1): FrozenBatchNorm2d(512, eps=0.0)
          (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
          (bn2): FrozenBatchNorm2d(512, eps=0.0)
          (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
          (bn3): FrozenBatchNorm2d(2048, eps=0.0)
          (relu): ReLU(inplace=True)
        )
      )
    )
    (fpn): FeaturePyramidNetwork(
      (inner_blocks): ModuleList(
        (0): Conv2d(256, 256, kernel_size=(1, 1), stride=(1, 1))
        (1): Conv2d(512, 256, kernel_size=(1, 1), stride=(1, 1))
        (2): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1))
        (3): Conv2d(2048, 256, kernel_size=(1, 1), stride=(1, 1))
      )
      (layer_blocks): ModuleList(
        (0): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (1): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
        (3): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
      )
      (extra_blocks): LastLevelMaxPool()
    )
  )
  (rpn): RegionProposalNetwork(
    (anchor_generator): AnchorGenerator()
    (head): RPNHead(
      (conv): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1))
      (cls_logits): Conv2d(256, 3, kernel_size=(1, 1), stride=(1, 1))
      (bbox_pred): Conv2d(256, 12, kernel_size=(1, 1), stride=(1, 1))
    )
  )
  (roi_heads): RoIHeads(
    (box_roi_pool): MultiScaleRoIAlign(featmap_names=[&#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;], output_size=(7, 7), sampling_ratio=2)
    (box_head): TwoMLPHead(
      (fc6): Linear(in_features=12544, out_features=1024, bias=True)
      (fc7): Linear(in_features=1024, out_features=1024, bias=True)
    )
    (box_predictor): FastRCNNPredictor(
      (cls_score): Linear(in_features=1024, out_features=91, bias=True)
      (bbox_pred): Linear(in_features=1024, out_features=364, bias=True)
    )
  )
)
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1"># For training</span>
<span class="n">images</span><span class="p">,</span> <span class="n">boxes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">1200</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">boxes</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
<span class="n">images</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">image</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">labels</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>torch.Size([4, 11])
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)):</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">d</span><span class="p">[</span><span class="s1">&#39;boxes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">d</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span>     <span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1"># For inference</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">400</span><span class="p">)]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>
</code></pre></div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-2022 Gao Hongnan
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://sg.linkedin.com/in/reighnss" target="_blank" rel="noopener" title="sg.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
    
    
    <a href="https://github.com/gao-hongnan" target="_blank" rel="noopener" title="gaohn" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../../../..", "features": ["content.code.annotate"], "search": "../../../../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.ed9748b7.min.js"></script>
      
        <script src="../../../../../javascript/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>